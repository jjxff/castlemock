# Castle Mock v1.69.2 Community Fork

**Release Date**: January 26, 2025
**Type**: Patch Release (New Features & Bug Fix)

## ðŸ“… New Feature: Dynamic Date and Time Expressions

### Overview
Added comprehensive **date and time expression support** for generating dynamic timestamps in mock responses. This enables realistic mock APIs with time-based data like expiration dates, timestamps, and time-sensitive calculations.

### Key Features

#### âœ… **NOW Expression**
- **Syntax**: `${NOW}` or `${NOW(offset="duration")}`
- **Output**: ISO-8601 formatted timestamp (e.g., `2025-01-26T14:30:45Z`)
- **Use Cases**: Current timestamps, expiration times, future/past dates

```
${NOW}                           // Current timestamp
${NOW(offset="30 seconds")}      // 30 seconds from now
${NOW(offset="-15 minutes")}     // 15 minutes ago
${NOW(offset="2 hours")}         // 2 hours from now
${NOW(offset="5 days")}          // 5 days from now
```

#### âœ… **DATE Expression**
- **Syntax**: `${DATE}` or `${DATE(offset="duration")}`
- **Output**: ISO date format (e.g., `2025-01-26`)
- **Use Cases**: Due dates, validity periods, scheduling

```
${DATE}                          // Current date
${DATE(offset="7 days")}         // 7 days from today
${DATE(offset="-30 days")}       // 30 days ago
```

#### âœ… **TIME Expression**
- **Syntax**: `${TIME}` or `${TIME(offset="duration")}`
- **Output**: ISO time format (e.g., `14:30:45`)
- **Use Cases**: Business hours, scheduling, time-only calculations

```
${TIME}                          // Current time
${TIME(offset="45 minutes")}     // 45 minutes from now
${TIME(offset="-2 hours")}       // 2 hours ago
```

#### âœ… **Flexible Offset Support**
- **Units**: `seconds`, `minutes`, `hours`, `days` (singular or plural)
- **Direction**: Positive (future) or negative (past) offsets
- **Case Insensitive**: `NOW`, `now`, `Now` all work
- **Error Handling**: Invalid offsets fall back to current time

### Technical Implementation

#### Files Created
```
model/model-core/src/main/java/com/castlemock/model/core/utility/parser/expression/NowExpression.java
model/model-core/src/main/java/com/castlemock/model/core/utility/parser/expression/DateExpression.java
model/model-core/src/main/java/com/castlemock/model/core/utility/parser/expression/TimeExpression.java
model/model-core/src/test/java/com/castlemock/model/core/utility/parser/NowExpressionTest.java
model/model-core/src/test/java/com/castlemock/model/core/utility/parser/DateExpressionTest.java
model/model-core/src/test/java/com/castlemock/model/core/utility/parser/TimeExpressionTest.java
```

#### Files Modified
```
model/model-core/src/main/java/com/castlemock/model/core/utility/parser/TextParser.java
```

#### Core Technologies
- **Java Time API**: `Instant`, `LocalDate`, `LocalTime`
- **Pattern Matching**: Regex for offset parsing
- **ANTLR Integration**: Seamless expression parsing
- **ISO Standards**: ISO-8601 date/time formatting

---

## ðŸ”§ Critical Bug Fix: JSON Path Body Mapping

### Issue Fixed
The `${BODY_JSON_PATH()}` expression was returning empty values when copying fields from request JSON to response templates.

### Root Cause
`ExternalInputBuilder` was only mapping request body for XPath expressions but not for JSON Path expressions, causing JSON Path operations to fail silently.

### Solution
Fixed `ExternalInputBuilder.build()` method to properly map request body for both XPath and JSON Path expressions.

### Technical Details

#### File Modified
```
model/model-core/src/main/java/com/castlemock/model/core/utility/parser/ExternalInputBuilder.java
```

#### Changes Made
- Added missing import: `BodyJsonPathExpression`
- Added JSON Path body mapping: `immutableMapBuilder.put(BodyJsonPathExpression.BODY_ARGUMENT, bodyArgument);`

#### Before Fix
```java
// Only XPath body mapping
immutableMapBuilder.put(BodyXPathExpression.BODY_ARGUMENT, bodyArgument);
```

#### After Fix
```java
// Both XPath and JSON Path body mapping
immutableMapBuilder.put(BodyXPathExpression.BODY_ARGUMENT, bodyArgument);
immutableMapBuilder.put(BodyJsonPathExpression.BODY_ARGUMENT, bodyArgument);
```

### Impact
- âœ… **Fixed**: `${BODY_JSON_PATH(expression="$.fieldName")}` now works correctly
- âœ… **Enables**: Copying request JSON fields to response templates
- âœ… **Backward Compatible**: No changes required for existing functionality

---

## ðŸ“– Documentation Enhancements

### README.md Updates
- **New Section**: "Dynamic Expressions" with comprehensive examples
- **Complete Coverage**: All available expressions documented
- **Practical Examples**: Real-world usage scenarios
- **Syntax Reference**: Clear formatting and parameter documentation

### Expression Categories Documented
1. **Date and Time Expressions**: NOW, DATE, TIME
2. **Request Data Expressions**: JSON Path, XPath, Query Strings, Path Parameters
3. **Random Data Expressions**: UUID, Integers, Decimals, Strings
4. **Usage Guidelines**: Best practices and configuration notes

---

## Version Update
- **Version**: Updated from 1.69.1 to 1.69.2
- **Maven**: Main pom.xml updated
- **Documentation**: README.md updated with new features

## Compatibility
- âœ… **100% Backward Compatible**: All existing functionality preserved
- âœ… **Optional Features**: New expressions only activate when used
- âœ… **No Breaking Changes**: Existing projects work unchanged

## Use Cases

### OTP/Token Expiration
```json
{
  "token": "${RANDOM_UUID}",
  "expiresAt": "${NOW(offset=\"300 seconds\")}",
  "issuedAt": "${NOW}"
}
```

### Date-Based Business Logic
```json
{
  "today": "${DATE}",
  "dueDate": "${DATE(offset=\"30 days\")}",
  "lastUpdated": "${NOW}",
  "businessHours": "${TIME(offset=\"9 hours\")}"
}
```

### Request Data Copying
```json
{
  "userId": "${BODY_JSON_PATH(expression=\"$.userId\")}",
  "processedAt": "${NOW}",
  "validUntil": "${DATE(offset=\"365 days\")}"
}
```

---

## Migration Guide
**No migration required** - All changes are backward compatible and new features are opt-in.

## Testing
- **Comprehensive Test Coverage**: All new expressions include full unit test suites
- **Edge Case Handling**: Invalid offsets, boundary conditions, format validation
- **Real-time Validation**: Time-based assertions with execution tolerance

---

*This release significantly enhances CastleMock's dynamic response capabilities, enabling realistic time-based mock APIs while maintaining full backward compatibility.*